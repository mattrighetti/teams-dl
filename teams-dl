#!/bin/bash

source scriptUtils.sh

function __check_output() {
    if [[ $? -ne 0 ]]; then
        echo "Error getting JSON"
        exit 1
    fi
}

function getMainJSON() {
    VIDEO_ID=$1

    curl -s "https://euwe-1.api.microsoftstream.com/api/videos/${VIDEO_ID}?\$expand=creator&api-version=1.0-private" \
         -H "Authorization: Bearer ${TOKEN}" > mainJSON.txt
    
    cat mainJSON.txt
}

function videolink_query() {
    LINK=$1

    curl -s $LINK \
        -H "Authorization: Bearer ${TOKEN}" > videolinkData.txt
    
    cat videolinkData.txt | \
        grep -o -E 'URI=".*"' | \
        tail -1 | \
        grep -o -E '".*"' | \
        tr -d '"'
}

function protectionKeyUri_query() {
    LINK=$1

    curl -s $LINK \
        -H "Authorization: Bearer ${TOKEN}" > keyUri.txt
    
    cat keyUri.txt | \
    grep -o -E 'URI=".*"' | \
    grep -o -E '".*"' | \
    tr -d '"'
}

function video_data_full() {
    LINK=$1
    BASE=$2

    curl -s $LINK \
        -H "Authorization: Bearer ${TOKEN}" > video_full.m3u8
}

function protectionKey_query() {
    LINK=$1

    curl -s $LINK \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "encoding: null" > key.txt

    cat key.txt
}

function video_data_tmp() {
    TMP_KEY="file://$(pwd)/videos"
    KEY_FILE="my.key"
    ID=$( cat video_full.m3u8 | grep -o -E '".*"' | sed -E "s/.*api\/videos\/([A-Za-z0-9-]+)\/.*/\1/" )

    NEW_URI="${TMP_KEY}/${ID}/${KEY_FILE}"

    cat video_full.m3u8 | \
        sed -e "s#\".*\"#\"${NEW_URI}\"#" | \
        sed -E "s/.*(Fragments.*)/\1/" > video_tmp.m3u8
}

function aria2video_download() {
    VIDEO_FULL=$1
    n=$2

    aria2c -i "${VIDEO_FULL}" \
        -j $n \
        -x $n \
        -d "./videos/video_segments" \
        --header="Authorization: Bearer ${TOKEN}"
}

function getBaseUrl() {
    HLS_URL=$1

    rm_part="${HLS_URL##*/}"
    echo ${HLS_URL/${rm_part}}
}

function getJSONdata() {
    JSON=$1
    FIELD=$2
    
    echo $JSON | \
    jq -r ".${FIELD}" 2>/dev/null
}

function download() {
    URL=$1
    FILENAME=$2

    echo "Downloading ${FILENAME}"
    ffmpeg -nostdin -headers "Authorization: Bearer ${TOKEN}" \
        -i "${URL}" \
        -codec:a copy \
        -codec:v copy \
        -n "${FILENAME}.mp4" 1>/dev/null 2>&1
}

export TOKEN=$(cat token)

LINK=$( cat links.txt )
guid=${LINK##*/}
JSON=$( getMainJSON ${guid} )
__check_output

HLS_URL=$(getJSONdata "${JSON}" "playbackUrls[2].playbackUrl")
infoln $HLS_URL

BASE_URL=$( getBaseUrl $HLS_URL )
warnln $BASE_URL

PLAYLIST_URI=$( videolink_query $HLS_URL | sed -E 's/,type=keyframes//' )
infoln $PLAYLIST_URI

PKEY_URL="$( protectionKeyUri_query "${PLAYLIST_URI}" )"
warnln $PKEY_URL

KEY_PROT="$( protectionKey_query $PKEY_URL )"
infoln $KEY_PROT

BASE_URI=${PLAYLIST_URI%\/*}
BASE_URI=${BASE_URI##*=}
warnln $BASE_URI

FULL_V=$( video_data_full $PLAYLIST_URI $BASE_URI )
video_data_tmp
aria2video_download "video_full.m3u8" 10

exit 0